#!/bin/bash
RED='\E[1;31m'
GREEN='\E[1;32m'
YELLOW='\E[1;33m'
BLUE='\E[1;34m'
PURPLE='\E[1;35m'
CYAN='\E[1;36m'
WHITE='\E[1;37m'
cRES='\E[0m'



echo -e "${WHITE}[...]\c" && echo -e "\t${WHITE}SmartDNS action${cRES}\r\c"
shttps1=$(awk '/server-https /' /opt/de_GWD/smartdns/smartdns.conf | awk NR==1)
shttps2=$(awk '/server-https /' /opt/de_GWD/smartdns/smartdns.conf | awk NR==2)
doh1str0=$(echo $shttps1 | awk '{print$2}' | sed 's?https://??' | grep "/dq")
doh2str0=$(echo $shttps2 | awk '{print$2}' | sed 's?https://??' | grep "/dq")
saddress1=$(awk '/address /' /opt/de_GWD/smartdns/smartdns.conf | awk NR==1)
saddress2=$(awk '/address /' /opt/de_GWD/smartdns/smartdns.conf | awk NR==2)

doh1Domain0=$(echo $doh1str0 | cut -d/ -f1 | cut -d: -f1)
doh2Domain0=$(echo $doh2str0 | cut -d/ -f1 | cut -d: -f1)

doh1IP0=$(echo $saddress1 | grep -Po '\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}')
doh2IP0=$(echo $saddress2 | grep -Po '\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}')

doh1=$(jq -r '.dns.doh[]' /opt/de_GWD/0conf 2>/dev/null | grep "/dq" | awk NR==1)
doh2=$(jq -r '.dns.doh[]' /opt/de_GWD/0conf 2>/dev/null | grep "/dq" | awk NR==2)

[[ -n $doh1 ]] && doh1Domain=$(echo $doh1 | cut -d/ -f1 | cut -d: -f1)
[[ -n $doh2 ]] && doh2Domain=$(echo $doh2 | cut -d/ -f1 | cut -d: -f1)

[[ -n $doh1 ]] && doh1IP=$(dig @127.0.0.1 $doh1Domain -4p 5331 +short  | grep -Po '\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}' | grep -v "127.0.0.1" | xargs -n 1 | awk NR==1)
[[ -n $doh2 ]] && doh2IP=$(dig @127.0.0.1 $doh2Domain -4p 5331 +short  | grep -Po '\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}' | grep -v "127.0.0.1" | xargs -n 1 | awk NR==1)

touch /opt/de_GWD/coredns/corefile
if [[ $(cat /opt/de_GWD/coredns/corefile 2>/dev/null | wc -l) -gt 5 ]]; then
DoGcIP0=$(awk '/grpc . /' /opt/de_GWD/coredns/corefile | grep -Po '\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}')
DoG=$(jq -r '.dns.dog' /opt/de_GWD/0conf 2>/dev/null | grep -v '^null$')
[[ -n $DoG ]] && DoGcDomain=$(echo $DoG | cut -d: -f1)
[[ -n $DoG ]] && DoGcIP=$(dig @127.0.0.1 $DoGcDomain -4p 5331 +short  | grep -Po '\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}' | grep -v "127.0.0.1" | xargs -n 1 | awk NR==1)
[[ -n $DoG ]] && DoGcPort=$(echo $DoG | cut -d: -f2 | grep '^[[:digit:]]*$')
fi

if [[ -n $DoGcIP ]] && [[ $DoGcIP != $DoGcIP0 ]]; then
sed -i '/DoGc_START/,/DoGc_END/d' /opt/de_GWD/coredns/corefile
tac /opt/de_GWD/coredns/corefile | awk 'NF>0{x=1}x' | tac | sponge /opt/de_GWD/coredns/corefile >/dev/null 2>&1
cat << EOF >>/opt/de_GWD/coredns/corefile
# DoGc_START
.:5333 {
  bind 127.0.0.1
  grpc . $DoGcIP:$DoGcPort {
    tls_servername $DoGcDomain
  }
  template ANY AAAA {
    rcode NXDOMAIN
  }
}
# DoGc_END
EOF
systemctl enable coredns >/dev/null 2>&1
systemctl restart coredns
elif [[ -z $DoGcIP ]]; then
sed -i '/DoGc_START/,/DoGc_END/d' /opt/de_GWD/coredns/corefile
  if [[ $(cat /opt/de_GWD/coredns/corefile | wc -c) -le 50 ]]; then
  systemctl disable coredns >/dev/null 2>&1
  systemctl stop coredns
  else
  systemctl restart coredns
  fi
fi



cat << EOF >/opt/de_GWD/smartdns/smartdns.conf
bind 127.0.0.1:5331 -group DNS_chn
bind-tcp 127.0.0.1:5331 -group DNS_chn

bind 127.0.0.1:5332 -no-speed-check -no-cache -group DNS_global
bind-tcp 127.0.0.1:5332 -no-speed-check -no-cache -group DNS_global

speed-check-mode tcp:443,ping
cache-size 0
cache-persist no
force-AAAA-SOA yes
dualstack-ip-selection no
prefetch-domain no
serve-expired no

log-level error
log-file /dev/null
log-size 32K
log-num 1

EOF

if [[ -z $(jq -r '.dns.china' /opt/de_GWD/0conf 2>/dev/null | grep -v '^null$') ]]; then
  jq --arg dnsChina "114.114.114.114 114.114.115.115 119.29.29.29 119.28.28.28 182.254.118.118 223.5.5.5 223.6.6.6" '.dns.china=$dnsChina' /opt/de_GWD/0conf | sponge /opt/de_GWD/0conf
  chmod 666 /opt/de_GWD/0conf
fi

for dnsChina in $(jq -r '.dns.china' /opt/de_GWD/0conf 2>/dev/null | grep -v '^null$'); do
    echo "server $dnsChina -exclude-default-group -group DNS_chn" >>/opt/de_GWD/smartdns/smartdns.conf
done

if [[ -n $doh1IP ]]; then
echo "address /$doh1Domain/$doh1IP" >>/opt/de_GWD/smartdns/smartdns.conf
echo "server-https https://$doh1 -no-check-certificate -group DNS_global" >>/opt/de_GWD/smartdns/smartdns.conf
elif [[ -z $doh1str0 ]]; then
>>/opt/de_GWD/smartdns/smartdns.conf
else
echo "address /$doh1Domain0/$doh1IP0" >>/opt/de_GWD/smartdns/smartdns.conf
echo "server-https https://$doh1str0 -no-check-certificate -group DNS_global" >>/opt/de_GWD/smartdns/smartdns.conf
fi

if [[ -n $doh2IP ]]; then
echo "address /$doh2Domain/$doh2IP" >>/opt/de_GWD/smartdns/smartdns.conf
echo "server-https https://$doh2 -no-check-certificate -group DNS_global" >>/opt/de_GWD/smartdns/smartdns.conf
elif [[ -z $doh2str0 ]]; then
>>/opt/de_GWD/smartdns/smartdns.conf
else
echo "address /$doh2Domain0/$doh2IP0" >>/opt/de_GWD/smartdns/smartdns.conf
echo "server-https https://$doh2str0 -no-check-certificate -group DNS_global" >>/opt/de_GWD/smartdns/smartdns.conf
fi

if [[ -n $DoGcIP ]]; then
echo "server 127.0.0.1:5333 -group DNS_global" >>/opt/de_GWD/smartdns/smartdns.conf
echo "server-tcp 127.0.0.1:5333 -group DNS_global" >>/opt/de_GWD/smartdns/smartdns.conf
fi



if [[ $DoGcIP != $DoGcIP0 ]] || [[ $doh1IP != $doh1IP0 ]] || [[ $doh2IP != $doh2IP0 ]] || [[ $1 = "r" ]]; then
systemctl restart smartdns
fi

if [[ -n $DoGcIP ]] || [[ -n $doh1IP ]] || [[ -n $doh2IP ]]; then
echo $DoGcIP $doh1IP $doh2IP | xargs -n1 | sort | uniq | sed 's/$/,/g' >/opt/de_GWD/nftables/IP_GlobalDNS
nft flush set ip de_GWD GlobalDNS
cat << EOF >/opt/de_GWD/nftables/SET_GlobalDNS.nft
#!/usr/sbin/nft -f
table ip de_GWD {
        set GlobalDNS {
                type ipv4_addr
                flags interval
                auto-merge
                elements = { $(cat /opt/de_GWD/nftables/IP_GlobalDNS) }
        }
}
EOF
chmod +x /opt/de_GWD/nftables/SET_GlobalDNS.nft
/opt/de_GWD/nftables/SET_GlobalDNS.nft &
fi

echo -e "${WHITE}[ ${GREEN}âœ“ ${WHITE}]\c" && echo -e "\t${WHITE}SmartDNS action${cRES}"
