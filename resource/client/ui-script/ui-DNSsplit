#!/bin/bash
cat << EOF >/tmp/v2dns_config
{
  "dns":{
    "tag":"dnsflow",
    "disableCache":true,
    "servers":[
    {"address":"127.0.0.1","port":5321},
    {"address":"127.0.0.1","port":5320,"skipFallback":true,"domains":[]},
    {"address":"127.0.0.1","port":5321,"skipFallback":true,"domains":["domain:google.com"]},
    {"address":"127.0.0.1","port":5310,"skipFallback":true,"domains":["domain:baidu.com"]},
    {"address":"127.0.0.1","port":5310,"skipFallback":true,"domains":["geosite:cn","geosite:tld-cn"],"expectIPs":["ext:geoipCN.dat:cn"]}
    ]
  },
  "routing":{
    "rules":[
      {"type":"field","inboundTag":["dnsin"],"outboundTag":"dnsout"},
      {"type":"field","inboundTag":["dnsflow"],"outboundTag":"direct"}
    ]
  },
  "inbounds":[
    {
      "tag":"dnsin",
      "port":5350,
      "listen":"127.0.0.1",
      "protocol":"dokodemo-door",
      "settings":{"address":"127.0.0.1","network":"tcp,udp"}
    }
  ],
  "outbounds":[
    {
      "tag":"dnsout",
      "protocol":"dns",
      "streamSettings":{"sockopt":{"mark":255}}
    },
    {
      "tag":"direct",
      "protocol":"freedom",
      "streamSettings":{"sockopt":{"mark":255}}
    }
  ]
}
EOF

if [[ -n $(jq -r '.dns.hosts' /opt/de_GWD/0conf 2>/dev/null | grep -v '^null$') ]]; then
jq -r '.dns.hosts | to_entries[] | [.value, .key] | @tsv' /opt/de_GWD/0conf 2>/dev/null | grep -v '^null$' | sed 's/[[:space:]][[:space:]]*/ /g' >/etc/pihole/custom.list

sed -i '/Hosts_START/,/Hosts_END/d' /etc/smartdns/smartdns.conf
echo "# Hosts_START" >>/etc/smartdns/smartdns.conf
cat /etc/pihole/custom.list | while read line
do
echo "address /$(echo $line | awk '{print$2}')/$(echo $line | awk '{print$1}')" >>/etc/smartdns/smartdns.conf
done
echo "# Hosts_END" >>/etc/smartdns/smartdns.conf
fi

/opt/de_GWD/ui-saveListBW

/opt/de_GWD/ui-saveNode

/opt/de_GWD/ui-directLinkDNS
