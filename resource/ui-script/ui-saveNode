#!/bin/bash
>/opt/de_GWD/IPv2node
jq -r '.v2node[].domain' /opt/de_GWD/0conf | cut -d: -f1 | sort | uniq | sed '/^\s*$/d' | xargs -n 8 | while read line
do
  for domainV2node in $line
  do
  dig @127.0.0.1 $domainV2node -p 5320 +short +tcp | grep -Po '\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}' | xargs -n1 >>/opt/de_GWD/IPv2node &
  done
  wait
done

sed -i '/^\s*$/d' /opt/de_GWD/IPv2node
sed -i 's/^/add v2node &/g' /opt/de_GWD/IPv2node
mv -f /opt/de_GWD/IPv2node /opt/de_GWD/IPv2nodeSET
ipset -! -R </opt/de_GWD/IPv2nodeSET

if [[ $1 == "r" ]]; then
	jq '.dns.servers[4].domains=[]' /opt/de_GWD/v2dns/config.json | sponge /opt/de_GWD/v2dns/config.json
	jq -r '.v2node[].domain' /opt/de_GWD/0conf | cut -d: -f1 | while read line
	do
	  jq --arg line $line '.dns.servers[4].domains+=[$line]' /opt/de_GWD/v2dns/config.json | sponge /opt/de_GWD/v2dns/config.json
	done
	chmod 666 /opt/de_GWD/v2dns/config.json
	systemctl restart v2dns >/dev/null
fi